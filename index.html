<html>

<head>
    <title>Popular times</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.css"
        integrity="sha256-iYUgmrapfDGvBrePJPrMWQZDcObdAcStKBpjP3Az+3s=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.js"
        integrity="sha256-CNm+7c26DTTCGRQkM9vp7aP85kHFMqs9MhPEuytF+fQ=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js"></script>
    <script src="https://unpkg.com/leaflet-spin@1.1.0/leaflet.spin.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet-providers@1.3.0/leaflet-providers.js"></script>
    <style>
        html,
        body,
        #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .legend {
            background-color: lightgray;
            padding: 15px;
        }

        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            border-radius: 50%;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script>
        var map = L.map('map', {
            worldCopyJump: true,
            zoomControl: false,
            center: [-36.8862, 174.7651],
            zoom: 12
        })

        var placesWithPopularTimes = L.layerGroup().addTo(map);
        var placesWithoutPopularTimes = L.layerGroup();

        var baseMaps = {
            "CartoDB Positron": L.tileLayer.provider('CartoDB.Positron').addTo(map),
            "CartoDB Dark Matter": L.tileLayer.provider("CartoDB.DarkMatter"),
        }
        var overlayMaps = {
            "Places with popular times": placesWithPopularTimes,
            "Places without popular times": placesWithoutPopularTimes,
        }
        L.control.layers(baseMaps, overlayMaps, { position: "topright" }).addTo(map);

        map.spin(true);
        $.getJSON("data.geojson", function (data) {
            console.log(data)
            map.spin(false);
            for (var d of data.features) {
                var p = d.properties
                if (p.populartimes) {
                    color = "blue"
                    layer = placesWithPopularTimes
                } else {
                    color = "red"
                    layer = placesWithoutPopularTimes
                }
                var lng = d.geometry.coordinates[0]
                var lat = d.geometry.coordinates[1]
                var marker = new L.circleMarker([lat, lng], { radius: 10, color: color }).addTo(layer).bindTooltip(p.name);
                marker.bindPopup(`<b><a href="${p.link}">${p.name}</a></b><br>
                    Address: ${p.address}<br>
                    Plus code: ${p.code}<br>
                    Latlong: ${d.geometry.coordinates}<br>
                    Live info: ${JSON.stringify(p.live_info)}<br>
                    Scraped at: ${p.scraped_at}<br>
                `)
            }
            updateStats()
        })

        function updateStats() {
            var count = 0;
            placesWithPopularTimes.eachLayer(function (layer) {
                if (map.getBounds().contains(layer.getLatLng())) {
                    count++;
                }
            });
            $("#placesWithPopularTimesC").text(count);

            count = 0;
            placesWithoutPopularTimes.eachLayer(function (layer) {
                if (map.getBounds().contains(layer.getLatLng())) {
                    count++;
                }
            });
            $("#placesWithoutPopularTimesC").text(count);
        }

        map.on("moveend", function () {
            console.log("moveend");
            updateStats();
        });

        L.control.zoom({
            position: 'topleft'
        }).addTo(map);

        var legend = L.control({ position: 'bottomright' });

        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend');
            div.innerHTML += `
                <i style="background:blue"></i>Places with popular times: <span id="placesWithPopularTimesC"></span><br>
                <i style="background:red"></i>Places without popular times: <span id="placesWithoutPopularTimesC"></span>`;
            return div;
        };

        legend.addTo(map);
    </script>
</body>

</html>